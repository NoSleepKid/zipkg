#!/bin/bash
set -euo pipefail

AUR_URL="https://aur.archlinux.org"
BUILD_DIR=""

usage() {
    cat <<EOF
Usage:
  zipkg -i <package>        Install package from AUR
  zipkg -r <package>        Remove package
  zipkg --tui               Use dmenu TUI
EOF
    exit 1
}

cleanup() {
    [[ -n "${BUILD_DIR:-}" && -d "$BUILD_DIR" ]] && rm -rf "$BUILD_DIR"
}
trap cleanup EXIT

require() {
    command -v "$1" >/dev/null 2>&1 || {
        echo "Error: '$1' is required but not installed."
        exit 1
    }
}

tui_menu() {
    require dmenu

    choice=$(printf "install\nremove\n" | dmenu -i -p "Action:")
    [[ -z "$choice" ]] && exit 0

    pkg=$(echo "" | dmenu -i -p "Package name:")
    [[ -z "$pkg" ]] && exit 0

    case "$choice" in
        install) action="-i" ;;
        remove)  action="-r" ;;
        *) exit 1 ;;
    esac
}

install_pkg() {
    local package="$1"

    if pacman -Qi "$package" &>/dev/null; then
        echo "Info: $package is already installed."
        exit 0
    fi

    require git
    require makepkg

    BUILD_DIR=$(mktemp -d -t zipkg-XXXX)
    git clone "$AUR_URL/$package.git" "$BUILD_DIR/$package"

    (
        cd "$BUILD_DIR/$package"
        makepkg -si --needed
    )
}

remove_pkg() {
    sudo pacman -Rns "$1"
}

[[ $# -eq 0 ]] && usage

action=""
package=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -i|-r)
            action="$1"
            package="${2:-}"
            shift 2
            ;;
        --tui)
            tui_menu
            shift
            ;;
        *)
            usage
            ;;
    esac
done

[[ -z "${action:-}" || -z "${package:-}" ]] && usage

case "$action" in
    -i) install_pkg "$package" ;;
    -r) remove_pkg "$package" ;;
    *) usage ;;
esac
