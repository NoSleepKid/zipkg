#!/bin/bash
set -euo pipefail

AUR_URL="https://aur.archlinux.org"
BUILD_DIR=""

usage() {
    cat <<EOF
Usage:
  zipkg -i <package>
  zipkg -r <package>
  zipkg --tui
EOF
    exit 1
}

cleanup() {
    [[ -n "${BUILD_DIR:-}" && -d "$BUILD_DIR" ]] && rm -rf "$BUILD_DIR"
}
trap cleanup EXIT

require() {
    command -v "$1" >/dev/null 2>&1 || exit 1
}

tui_menu() {
    require fzf
    require pacman

    action=$(printf "install\nremove\n" | fzf --prompt="action > " --height=40% --border)
    [[ -z "$action" ]] && exit 0

    if [[ "$action" == "remove" ]]; then
        package=$(pacman -Qq | fzf --prompt="package > " --height=80% --border)
        action="-r"
    else
        package=$(printf "" | fzf --prompt="AUR package > " --print-query --height=40% --border | head -n1)
        action="-i"
    fi

    [[ -z "$package" ]] && exit 0
}

install_pkg() {
    pacman -Qi "$1" &>/dev/null && exit 0

    require git
    require makepkg

    BUILD_DIR=$(mktemp -d -t zipkg-XXXX)
    git clone "$AUR_URL/$1.git" "$BUILD_DIR/$1"
    (
        cd "$BUILD_DIR/$1"
        makepkg -si --needed
    )
}

remove_pkg() {
    sudo pacman -Rns "$1"
}

[[ $# -eq 0 ]] && usage

action=""
package=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -i|-r)
            action="$1"
            package="${2:-}"
            shift 2
            ;;
        --tui)
            tui_menu
            shift
            ;;
        *)
            usage
            ;;
    esac
done

[[ -z "${action:-}" || -z "${package:-}" ]] && usage

case "$action" in
    -i) install_pkg "$package" ;;
    -r) remove_pkg "$package" ;;
    *) usage ;;
esac
