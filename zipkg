#!/bin/bash
set -euo pipefail

AUR_URL="https://aur.archlinux.org"
BUILD_DIR=""

cleanup() {
    [[ -n "${BUILD_DIR:-}" && -d "$BUILD_DIR" ]] && rm -rf "$BUILD_DIR"
}
trap cleanup EXIT

require() {
    command -v "$1" >/dev/null 2>&1 || exit 1
}

spinner() {
    local pid=$1
    local spin='-\|/'
    local i=0
    tput civis
    while kill -0 "$pid" 2>/dev/null; do
        i=$(( (i+1) %4 ))
        printf "\r[%c] Installing..." "${spin:$i:1}"
        sleep 0.1
    done
    printf "\r"
    tput cnorm
}

install_pkg() {
    pacman -Qi "$1" &>/dev/null && {
        printf "Already installed: %s\n" "$1"
        sleep 1
        return
    }

    require git
    require makepkg

    BUILD_DIR=$(mktemp -d -t zipkg-XXXX)
    git clone "$AUR_URL/$1.git" "$BUILD_DIR/$1" &>/dev/null

    (
        cd "$BUILD_DIR/$1"
        makepkg -si --needed --noconfirm &>/dev/null
    ) &
    pid=$!
    spinner "$pid"
    wait "$pid"

    printf "Finished installation of %s\n" "$1"
    sleep 1
}

remove_pkg() {
    sudo pacman -Rns "$1"
    sleep 1
}

main_menu() {
    require fzf

    while true; do
        action=$(printf "install\nremove\nexit\n" | fzf --prompt="zipkg > " --height=40% --border)
        [[ -z "$action" || "$action" == "exit" ]] && exit 0

        case "$action" in
            install)
                package=$(printf "" | fzf --print-query --prompt="AUR package > " --height=40% --border | head -n1)
                [[ -n "$package" ]] && install_pkg "$package"
                ;;
            remove)
                package=$(pacman -Qq | fzf --prompt="remove > " --height=80% --border)
                [[ -n "$package" ]] && remove_pkg "$package"
                ;;
        esac
    done
}

[[ "${1:-}" == "--tui" ]] && main_menu

case "${1:-}" in
    -i) install_pkg "${2:-}" ;;
    -r) remove_pkg "${2:-}" ;;
    *) main_menu ;;
esac
